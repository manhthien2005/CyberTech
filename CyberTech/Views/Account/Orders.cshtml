@model List<CyberTech.Models.Order>
@{
    ViewData["Title"] = "Quản lý đơn hàng";
    
    var statuses = new[] {
        new { Value = "", Text = "Tất cả" },
        new { Value = "Pending", Text = "Chờ xử lý" },
        new { Value = "Processing", Text = "Đang xử lý" },
        new { Value = "Shipped", Text = "Đang giao hàng" },
        new { Value = "Delivered", Text = "Đã giao hàng" },
        new { Value = "Cancelled", Text = "Đã hủy" },
        new { Value = "Returned", Text = "Đã trả hàng" }
    };
    
    var paymentStatuses = new[] {
        new { Value = "", Text = "Tất cả" },
        new { Value = "Pending", Text = "Chờ thanh toán" },
        new { Value = "Completed", Text = "Đã thanh toán" },
        new { Value = "Failed", Text = "Thanh toán thất bại" },
        new { Value = "Refunded", Text = "Đã hoàn tiền" }
    };
}

@Html.AntiForgeryToken()

<div class="account-dashboard">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3">
            @Html.Partial("_AccountSidebar")
        </div>
        <!-- Main Content -->
        <div class="col-lg-9">
            <div class="account-content-main">
                <div class="orders-section">
                    <h2>Quản lý đơn hàng</h2>
                    
                    <!-- Status Tabs -->
                    <ul class="nav nav-tabs mb-4" id="orderStatusTabs" role="tablist">
                        @foreach (var status in statuses)
                        {
                            var isActive = (ViewBag.StatusFilter == status.Value) || (string.IsNullOrEmpty(ViewBag.StatusFilter) && string.IsNullOrEmpty(status.Value));
                            <li class="nav-item" role="presentation">
                                <a class="nav-link @(isActive ? "active" : "")" 
                                   id="@(string.IsNullOrEmpty(status.Value) ? "all" : status.Value.ToLower())-tab" 
                                   href="@Url.Action("Orders", new { status = status.Value, search = ViewBag.SearchTerm, date = ViewBag.DateFilter, paymentStatus = ViewBag.PaymentStatusFilter })" 
                                   role="tab">
                                    @status.Text
                                </a>
                            </li>
                        }
                    </ul>
                    
                    <!-- Search Form -->
                    <div class="search-box">
                        <form id="searchOrderForm" class="row g-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="orderSearch" name="search" placeholder="Tìm theo mã đơn hàng..." value="@ViewBag.SearchTerm">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="paymentStatusFilter" name="paymentStatus">
                                    @foreach (var payStatus in paymentStatuses)
                                    {
                                        <option value="@payStatus.Value" selected="@(ViewBag.PaymentStatusFilter == payStatus.Value)">@payStatus.Text</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control" id="dateFilter" name="date" value="@ViewBag.DateFilter">
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search me-2"></i>Tìm kiếm
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Mã đơn</th>
                                    <th>Ngày đặt</th>
                                    <th>Trạng thái</th>
                                    <th>Thanh toán</th>
                                    <th>Tổng tiền</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var order in Model)
                                {
                                    var payment = order.Payments?.FirstOrDefault();
                                    var hasSuccessfulPayment = payment != null && payment.PaymentStatus == "Completed";
                                    var canCancel = (order.Status == "Pending" || order.Status == "Processing") && (DateTime.Now - order.CreatedAt).TotalHours <= 5 && !hasSuccessfulPayment;
                                    <tr>
                                        <td data-label="Mã đơn" class="order-id">@order.OrderID</td>
                                        <td data-label="Ngày đặt" class="order-date">@order.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                        <td data-label="Trạng thái">
                                            <span class="status-badge status-@order.Status.ToLower()">
                                                @{
                                                    var statusText = order.Status switch
                                                    {
                                                        "Pending" => "Chờ xử lý",
                                                        "Processing" => "Đang xử lý",
                                                        "Shipped" => "Đang giao hàng",
                                                        "Delivered" => "Đã giao hàng",
                                                        "Cancelled" => "Đã hủy",
                                                        "Returned" => "Đã trả hàng",
                                                        _ => order.Status
                                                    };
                                                }
                                                @statusText
                                            </span>
                                        </td>
                                        <td data-label="Thanh toán">
                                            @{
                                                if (payment != null)
                                                {
                                                    var paymentStatusText = payment.PaymentStatus switch
                                                    {
                                                        "Pending" => "Chờ thanh toán",
                                                        "Completed" => "Đã thanh toán",
                                                        "Failed" => "Thanh toán thất bại",
                                                        "Refunded" => "Đã hoàn tiền",
                                                        _ => payment.PaymentStatus
                                                    };
                                                    <span class="payment-badge payment-@payment.PaymentStatus.ToLower()">@paymentStatusText</span>
                                                }
                                                else
                                                {
                                                    <span class="payment-badge payment-pending">Chưa thanh toán</span>
                                                }
                                            }
                                        </td>
                                        <td data-label="Tổng tiền" class="order-amount">@order.FinalPrice.ToString("N0") đ</td>
                                        <td data-label="Thao tác" class="order-actions">
                                            <button type="button" class="btn btn-view view-order-details" data-id="@order.OrderID">
                                                <i class="fas fa-eye me-1"></i>Chi tiết
                                            </button>
                                            @if (canCancel)
                                            {
                                                <button type="button" class="btn btn-cancel cancel-order" data-id="@order.OrderID">
                                                    <i class="fas fa-times me-1"></i>Hủy
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination-container mt-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="pagination-info">
                                @if (ViewBag.TotalOrders > 0)
                                {
                                    <span>Hiển thị @(((ViewBag.CurrentPage - 1) * 3) + 1) - @(Math.Min(ViewBag.CurrentPage * 3, ViewBag.TotalOrders)) của @ViewBag.TotalOrders đơn hàng</span>
                                }
                                else
                                {
                                    <span>Không tìm thấy đơn hàng nào</span>
                                }
                            </div>
                            @if (ViewBag.TotalPages > 1)
                            {
                                <nav aria-label="Page navigation">
                                    <ul class="pagination mb-0">
                                        <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                                            <a class="page-link" href="@Url.Action("Orders", new { page = ViewBag.CurrentPage - 1, search = ViewBag.SearchTerm, status = ViewBag.StatusFilter, date = ViewBag.DateFilter, paymentStatus = ViewBag.PaymentStatusFilter })" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>
                                        @{
                                            var currentPage = ViewBag.CurrentPage;
                                            var totalPages = ViewBag.TotalPages;
                                            var pagesToShow = 2; // Show only 2 pages before and after current page

                                            // Always show first page
                                            if (currentPage > 3)
                                            {
                                                <li class="page-item">
                                                    <a class="page-link" href="@Url.Action("Orders", new { page = 1, search = ViewBag.SearchTerm, status = ViewBag.StatusFilter, date = ViewBag.DateFilter, paymentStatus = ViewBag.PaymentStatusFilter })">1</a>
                                                </li>
                                                if (currentPage > 4)
                                                {
                                                    <li class="page-item disabled">
                                                        <span class="page-link">...</span>
                                                    </li>
                                                }
                                            }

                                            // Show pages around current page
                                            for (int i = Math.Max(1, currentPage - pagesToShow); i <= Math.Min(totalPages, currentPage + pagesToShow); i++)
                                            {
                                                <li class="page-item @(i == currentPage ? "active" : "")">
                                                    <a class="page-link" href="@Url.Action("Orders", new { page = i, search = ViewBag.SearchTerm, status = ViewBag.StatusFilter, date = ViewBag.DateFilter, paymentStatus = ViewBag.PaymentStatusFilter })">@i</a>
                                                </li>
                                            }

                                            // Always show last page
                                            if (currentPage < totalPages - 2)
                                            {
                                                if (currentPage < totalPages - 3)
                                                {
                                                    <li class="page-item disabled">
                                                        <span class="page-link">...</span>
                                                    </li>
                                                }
                                                <li class="page-item">
                                                    <a class="page-link" href="@Url.Action("Orders", new { page = totalPages, search = ViewBag.SearchTerm, status = ViewBag.StatusFilter, date = ViewBag.DateFilter, paymentStatus = ViewBag.PaymentStatusFilter })">@totalPages</a>
                                                </li>
                                            }
                                        }
                                        <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
                                            <a class="page-link" href="@Url.Action("Orders", new { page = ViewBag.CurrentPage + 1, search = ViewBag.SearchTerm, status = ViewBag.StatusFilter, date = ViewBag.DateFilter, paymentStatus = ViewBag.PaymentStatusFilter })" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">Chi tiết đơn hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <!-- Order Status Timeline -->
                    <div class="col-12">
                        <div class="order-timeline">
                            <div class="timeline">
                                <div class="timeline-item" data-status="Pending">
                                    <div class="timeline-point">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6>Chờ xử lý</h6>
                                        <p class="timeline-date"></p>
                                    </div>
                                </div>
                                <div class="timeline-item" data-status="Processing">
                                    <div class="timeline-point">
                                        <i class="fas fa-cog"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6>Đang xử lý</h6>
                                        <p class="timeline-date"></p>
                                    </div>
                                </div>
                                <div class="timeline-item" data-status="Shipped">
                                    <div class="timeline-point">
                                        <i class="fas fa-truck"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6>Đang giao hàng</h6>
                                        <p class="timeline-date"></p>
                                    </div>
                                </div>
                                <div class="timeline-item" data-status="Delivered">
                                    <div class="timeline-point">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6>Giao hàng thành công</h6>
                                        <p class="timeline-date"></p>
                                    </div>
                                </div>
                                <div class="timeline-item d-none" data-status="Cancelled">
                                    <div class="timeline-point">
                                        <i class="fas fa-times-circle"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6>Đã hủy</h6>
                                        <p class="timeline-date"></p>
                                    </div>
                                </div>
                                <div class="timeline-item d-none" data-status="Returned">
                                    <div class="timeline-point">
                                        <i class="fas fa-undo"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6>Đã trả hàng</h6>
                                        <p class="timeline-date"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Info & Payment -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title mb-3">Thông tin đơn hàng</h6>
                                <div class="order-info">
                                    <p><strong>Mã đơn:</strong> <span id="orderId"></span></p>
                                    <p><strong>Ngày đặt:</strong> <span id="orderDate"></span></p>
                                    <p><strong>Trạng thái:</strong> <span id="orderStatus"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title mb-3">Thông tin thanh toán</h6>
                                <div class="payment-info">
                                    <p><strong>Phương thức:</strong> <span id="paymentMethod"></span></p>
                                    <p><strong>Trạng thái:</strong> <span id="paymentStatus"></span></p>
                                    <p><strong>Ngày thanh toán:</strong> <span id="paymentDate"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Address -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title mb-3">Địa chỉ giao hàng</h6>
                                <div class="address-info">
                                    <p><strong>Người nhận:</strong> <span id="recipientName"></span></p>
                                    <p><strong>Số điện thoại:</strong> <span id="recipientPhone"></span></p>
                                    <p><strong>Địa chỉ:</strong> <span id="addressLine"></span></p>
                                    <p><strong>Phường/Xã:</strong> <span id="addressWard"></span></p>
                                    <p><strong>Quận/Huyện:</strong> <span id="addressDistrict"></span></p>
                                    <p><strong>Tỉnh/Thành phố:</strong> <span id="addressCity"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Items -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title mb-3">Sản phẩm</h6>
                                <div class="order-items">
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th style="width: 80px">Hình ảnh</th>
                                                    <th>Sản phẩm</th>
                                                    <th class="text-center">Số lượng</th>
                                                    <th class="text-end">Đơn giá</th>
                                                    <th class="text-end">Thành tiền</th>
                                                </tr>
                                            </thead>
                                            <tbody id="orderItemsTable">
                                                <!-- Order items will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="row justify-content-end">
                                    <div class="col-md-4">
                                        <table class="table table-sm">
                                            <tr>
                                                <td>Tổng tiền hàng:</td>
                                                <td class="text-end" id="subtotal"></td>
                                            </tr>
                                            <tr>
                                                <td>Giảm giá sản phẩm:</td>
                                                <td class="text-end" id="productDiscount"></td>
                                            </tr>
                                            <tr>
                                                <td>Giảm giá thành viên:</td>
                                                <td class="text-end" id="rankDiscount"></td>
                                            </tr>
                                            <tr>
                                                <td>Giảm giá voucher:</td>
                                                <td class="text-end" id="voucherDiscount"></td>
                                            </tr>
                                            <tr>
                                                <td>Tổng giảm giá:</td>
                                                <td class="text-end" id="totalDiscount"></td>
                                            </tr>
                                            <tr class="fw-bold">
                                                <td>Tổng thanh toán:</td>
                                                <td class="text-end" id="total"></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/account-dashboard.css">
    <style>
        /* Status Tabs */
        .nav-tabs {
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
            flex-wrap: nowrap;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        
        .nav-tabs .nav-item {
            margin-bottom: -1px;
        }
        
        .nav-tabs .nav-link {
            border: 1px solid transparent;
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
            color: #6c757d;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.2s ease;
        }
        
        .nav-tabs .nav-link:hover {
            border-color: #e9ecef #e9ecef #dee2e6;
            color: #495057;
        }
        
        .nav-tabs .nav-link.active {
            color: #0077cc;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
            border-bottom: 2px solid #0077cc;
        }
        
        /* Hide scrollbar for Chrome, Safari and Opera */
        .nav-tabs::-webkit-scrollbar {
            display: none;
        }
        
        /* Hide scrollbar for IE, Edge and Firefox */
        .nav-tabs {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        .order-timeline {
            position: relative;
            padding: 20px 0;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .timeline {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0 20px;
        }
        .paymentStatusFilter{
            line-height: 1.9rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e9ecef;
            z-index: 1;
        }

        .timeline-item {
            position: relative;
            flex: 1;
            text-align: center;
            padding: 0 10px;
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .timeline-item.active {
            opacity: 1;
        }

        .timeline-item.completed .timeline-point {
            background: #28a745;
            border-color: #28a745;
        }

        .timeline-item.cancelled .timeline-point {
            background: #dc3545;
            border-color: #dc3545;
        }

        .timeline-item.returned .timeline-point {
            background: #6c757d;
            border-color: #6c757d;
        }

        .timeline-point {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            border: 2px solid #fff;
            margin: 0 auto 10px;
            z-index: 2;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timeline-point i {
            font-size: 1.2rem;
            color: #fff;
        }

        .timeline-item.active .timeline-point {
            background: #0077cc;
            border-color: #0077cc;
            transform: scale(1.1);
        }

        .timeline-content {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .timeline-item.active .timeline-content {
            background: #e3f2fd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .timeline-content h6 {
            margin: 0;
            font-size: 0.875rem;
            color: #495057;
        }

        .timeline-date {
            font-size: 0.75rem;
            color: #6c757d;
            margin: 5px 0 0;
        }

        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .card-title {
            color: #495057;
            font-weight: 600;
        }

        .order-info p, .payment-info p {
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .order-info p:last-child, .payment-info p:last-child {
            margin-bottom: 0;
        }

        .table th {
            font-weight: 600;
            color: #495057;
            font-size: 0.875rem;
        }

        .table td {
            vertical-align: middle;
            font-size: 0.875rem;
        }

        .modal-dialog.modal-xl {
            max-width: 90%;
            margin: 1.75rem auto;
        }

        .modal-content {
            height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .modal-header {
            padding: 1.5rem 1.5rem 0;
        }

        .search-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        /* Status colors */
        .status-badge {
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 600;
            border-radius: 0.25rem;
        }

        .status-pending { background-color: #ffc107; color: #000; }
        .status-processing { background-color: #17a2b8; color: #fff; }
        .status-shipped { background-color: #007bff; color: #fff; }
        .status-delivered { background-color: #28a745; color: #fff; }
        .status-cancelled { background-color: #dc3545; color: #fff; }
        .status-returned { background-color: #6c757d; color: #fff; }

        /* Pagination Styles */
        .pagination-container {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .pagination-info {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .pagination {
            margin: 0;
        }

        .page-link {
            color: #0077cc;
            border: 1px solid #dee2e6;
            padding: 0.5rem 0.75rem;
            margin: 0 2px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .page-link:hover {
            background-color: #e9ecef;
            border-color: #dee2e6;
            color: #0056b3;
        }

        .page-item.active .page-link {
            background-color: #0077cc;
            border-color: #0077cc;
            color: #fff;
        }

        .page-item.disabled .page-link {
            color: #6c757d;
            pointer-events: none;
            background-color: #fff;
            border-color: #dee2e6;
        }

        .btn-cancel {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: #c82333;
            color: white;
        }

        .btn-cancel:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }
    </style>
}

@section Scripts {
<script>
    var orderStatusMap = {
            'Pending': 'Chờ xử lý',
            'Processing': 'Đang xử lý', 
            'Shipped': 'Đang giao hàng',
            'Delivered': 'Đã giao hàng',
            'Cancelled': 'Đã hủy',
            'Returned': 'Đã trả hàng'
        };

        var paymentStatusMap = {
            'Pending': 'Chờ thanh toán',
            'Completed': 'Đã thanh toán',
            'Failed': 'Thanh toán thất bại',
            'Refunded': 'Đã hoàn tiền'
        };

        // Helper function to get status text
        function getStatusText(status, statusMap) {
            return statusMap[status] || status || 'N/A';
        }
    $(function() {
        // Search functionality
        $('#searchOrderForm').on('submit', function(e) {
            e.preventDefault();
            var searchTerm = $('#orderSearch').val();
            var paymentStatusFilter = $('#paymentStatusFilter').val();
            var dateFilter = $('#dateFilter').val();
            var statusFilter = '@ViewBag.StatusFilter'; // Keep the current status tab

            var url = '@Url.Action("Orders")' + '?page=1';
            if (searchTerm) url += '&search=' + encodeURIComponent(searchTerm);
            if (statusFilter) url += '&status=' + encodeURIComponent(statusFilter);
            if (paymentStatusFilter) url += '&paymentStatus=' + encodeURIComponent(paymentStatusFilter);
            if (dateFilter) url += '&date=' + encodeURIComponent(dateFilter);

            window.location.href = url;
        });

        // Clear filters
        $('.clear-filters').on('click', function(e) {
            e.preventDefault();
            window.location.href = '@Url.Action("Orders")';
        });

        // View Order Details
        $('.view-order-details').on('click', function() {
            var orderId = $(this).data('id');
            $.get('/Account/OrderDetails/' + orderId, function(data) {
                // Update modal content
                $('#orderId').text(data.orderId);
                $('#orderDate').text(new Date(data.createdAt).toLocaleString());
                
                // Update status with badge
                
                var statusClass = 'status-' + data.status.toLowerCase();
                var statusText = getStatusText(data.status, orderStatusMap);
                $('#orderStatus').html(`<span class="status-badge ${statusClass}">${statusText}</span>`);
                
                $('#paymentMethod').text(data.paymentMethod || 'Chưa thanh toán');

                var paymentStatusText = getStatusText(data.paymentStatus, paymentStatusMap);
                $('#paymentStatus').text(paymentStatusText);
                $('#paymentDate').text(data.paymentDate ? new Date(data.paymentDate).toLocaleString() : 'N/A');
                $('#subtotal').text(data.totalPrice.toLocaleString() + ' đ');
                $('#productDiscount').text(data.productDiscountAmount.toLocaleString() + ' đ');
                $('#rankDiscount').text(data.rankDiscountAmount.toLocaleString() + ' đ');
                $('#voucherDiscount').text(data.voucherDiscountAmount.toLocaleString() + ' đ');
                $('#totalDiscount').text(data.totalDiscountAmount.toLocaleString() + ' đ');
                $('#total').text(data.finalPrice.toLocaleString() + ' đ');

                // Update timeline
                $('.timeline-item').removeClass('active completed cancelled returned');
                
                // Hide cancelled and returned statuses by default
                $('.timeline-item[data-status="Cancelled"], .timeline-item[data-status="Returned"]').addClass('d-none');
                
                // Define status order for normal flow
                var normalStatusOrder = ['Pending', 'Processing', 'Shipped', 'Delivered'];
                var currentStatusIndex = normalStatusOrder.indexOf(data.status);
                
                if (currentStatusIndex >= 0) {
                    // Show normal flow
                    $('.timeline-item').slice(0, 4).removeClass('d-none');
                    
                    // Mark all previous statuses as completed
                    $('.timeline-item').slice(0, currentStatusIndex).addClass('completed');
                    
                    // Mark current status as active
                    $(`.timeline-item[data-status="${data.status}"]`).addClass('active');
                } else if (data.status === 'Cancelled') {
                    // Show cancelled status
                    $('.timeline-item[data-status="Cancelled"]').removeClass('d-none');
                    $(`.timeline-item[data-status="Cancelled"]`).addClass('active cancelled');
                } else if (data.status === 'Returned') {
                    // Show returned status
                    $('.timeline-item[data-status="Returned"]').removeClass('d-none');
                    $(`.timeline-item[data-status="Returned"]`).addClass('active returned');
                }

                // Update order items
                var itemsHtml = '';
                data.orderItems.forEach(function(item) {
                    itemsHtml += `
                        <tr>
                            <td>
                                <img src="${item.product.imageUrl}" class="img-thumbnail" alt="${item.product.name}" style="width: 60px; height: 60px; object-fit: cover;">
                            </td>
                            <td>
                                <div class="fw-medium">${item.product.name}</div>
                            </td>
                            <td class="text-center">${item.quantity}</td>
                            <td class="text-end">${item.unitPrice.toLocaleString()} đ</td>
                            <td class="text-end">${item.finalSubtotal.toLocaleString()} đ</td>
                        </tr>
                    `;
                });
                $('#orderItemsTable').html(itemsHtml);

                // Update shipping address
                if (data.address) {
                    $('#recipientName').text(data.address.recipientName);
                    $('#recipientPhone').text(data.address.phone);
                    $('#addressLine').text(data.address.addressLine);
                    $('#addressWard').text(data.address.ward);
                    $('#addressDistrict').text(data.address.district);
                    $('#addressCity').text(data.address.city);
                } else {
                    $('#recipientName').text('N/A');
                    $('#recipientPhone').text('N/A');
                    $('#addressLine').text('N/A');
                    $('#addressWard').text('N/A');
                    $('#addressDistrict').text('N/A');
                    $('#addressCity').text('N/A');
                }

                // Show modal
                var modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
                modal.show();
            });
        });

        // Cancel Order
        $('.cancel-order').on('click', function() {
            var orderId = $(this).data('id');
            if (confirm('Bạn có chắc chắn muốn hủy đơn hàng này?')) {
                $.ajax({
                    url: '/Account/CancelOrder/' + orderId,
                    type: 'POST',
                    headers: {
                        "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            utils.showToast('Hủy đơn hàng thành công', 'success');
                            location.reload();
                        } else {
                            utils.showToast(response.message || 'Không thể hủy đơn hàng', 'error');
                        }
                    },
                    error: function() {
                        utils.showToast('Có lỗi xảy ra khi hủy đơn hàng', 'error');
                    }
                });
            }
        });
    });
</script>
}